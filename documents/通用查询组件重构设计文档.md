# 通用查询组件重构设计文档


## 1. 组件重构目标

当前系统的通用“高级查询”组件采用的是一种较为传统的、基于多行重复表单的设计。用户每增加一个查询条件，就需要在一整行中分别设置“查询字段”、“条件”、“查询内容”和“连接条件”。这种方式存在以下痛点：

*   **操作繁琐**：增加、删除、修改查询条件需要用户进行大量点击和页面滚动，效率低下。
*   **界面冗余**：当查询条件较多时，界面会变得非常长，不直观，难以快速理解整个查询逻辑。
*   **逻辑不清晰**：`与`/`或`的连接逻辑分布在每一行，而不是作为条件的组合方式，不符合用户的自然思维习惯。

**重构目标**：设计一个现代化的、基于“标签化”和“动态构建”思想的通用查询组件。新组件应具备以下特性：

*   **直观易用**：用户可以像添加标签一样，快速构建和查看查询条件。
*   **动态灵活**：能够轻松地增加、删除和编辑查询条件，并支持复杂的`与`/`或`逻辑组合。
*   **交互友好**：整个过程流畅，减少不必要的弹窗和页面跳转，提升用户体验。
*   **高度复用**：作为一个独立的、配置化的`Vue`组件，可以轻松集成到系统内任何需要高级查询功能的页面中。

## 2. 新组件功能与交互设计

新组件命名为 `QueryBuilder`，其核心设计思路是**“将每一个查询条件封装成一个标签(Tag)”**，用户通过管理这些标签来构建最终的查询语句。

### 2.1 界面构成

组件主要由三个区域构成：

1.  **条件添加区 (Builder Area)**：用于创建新的查询条件。常驻在查询区域的顶部或通过点击“添加条件”按钮展开。
2.  **条件展示区 (Tags Area)**：用于显示所有已添加的条件标签，并管理它们之间的逻辑关系。
3.  **操作区 (Action Area)**：包含“查询”和“重置”按钮。

### 2.2 交互流程

**Step 1: 添加第一个条件**
*   在**条件添加区**，用户从左到右依次选择/输入：
    *   **查询字段** (`a-select`)：下拉选择要查询的字段（如“项目名称”）。
    *   **查询条件** (`a-select`)：根据所选字段的类型（文本、数字、日期等），动态加载可用的条件（如“包含”、“等于”、“大于”、“在...之间”）。
    *   **查询内容** (`a-input`, `a-input-number`, `a-range-picker`等)：根据所选条件，渲染对应的`Ant Design Vue`输入组件。例如，选择“在...之间”时，应渲染一个范围选择器。
*   完成设置后，点击“添加”按钮。

**Step 2: 条件生成标签**
*   点击“添加”后，一个代表该条件的**标签 (Tag)** 会出现在下方的**条件展示区**。例如：`[ 项目名称 包含 “市政工程” ] x`。
*   这个标签上应有关闭按钮(`x`)，用户可以随时点击删除该条件。

**Step 3: 添加更多条件与逻辑组合**
*   用户可以重复`Step 1`来添加第二个、第三个条件。
*   当**条件展示区**存在两个或以上条件时，在标签之间会自动出现一个逻辑连接切换器(`a-radio-group`或`a-switch`)。
    *   **[条件A]** `[ 与 | 或 ]` **[条件B]**
*   用户可以通过切换这个组件来定义所有条件是`AND`关系还是`OR`关系。这样设计比在每行单独设置 `与/或` 更清晰、更符合逻辑构建的整体性。

**Step 4: 高级逻辑 - 条件分组（可选增强）**
*   为了支持更复杂的查询（如 `(A and B) or C`），可以引入“条件组”的概念。
*   在**条件展示区**，提供一个“添加条件组”的按钮。
*   一个条件组可以看作是一个容器，内部可以包含多个条件标签，并且组内有独立的`与/或`逻辑。组与组之间、组与单个条件之间，也由一个全局的`与/或`逻辑连接。
*   **视觉表现**：条件组可以用一个带有背景色或边框的`div`包裹起来，以区别于单个条件。
    ```
    ┌───────────────────────────┐      ┌───────────┐
    │ [条件A] [与] [条件B]      │ [或] │ [条件C]   │
    └───────────────────────────┘      └───────────┘
    ```

**Step 5: 执行查询**
*   用户构建完查询逻辑后，点击**操作区**的“查询”按钮。
*   组件会触发一个`on-search`事件，并向外暴露一个结构化的`JSON`对象，供父组件用于调用API。

## 3. 组件实现方法 (技术规约)

该组件将作为通用的Vue组件进行开发，基于 `Ant Design Vue`。

### 3.1 组件`props`

组件应该是可配置的，通过`props`接收外部传入的字段定义。

```javascript
props: {
  fields: {
    type: Array,
    required: true,
    // example data structure for 'fields' prop
    /*
    [
      {
        key: 'projectName', // 字段唯一标识
        label: '项目名称', // 字段显示名称
        type: 'string', // 字段类型: string, number, date, select
      },
      {
        key: 'totalInvestment',
        label: '总投资',
        type: 'number',
      },
       {
        key: 'projectStatus',
        label: '项目状态',
        type: 'select',
        options: [ // 当type为select时，提供选项
          { label: '在建', value: 'building' },
          { label: '已完成', value: 'completed' },
        ]
      }
    ]
    */
  }
}
```

### 3.2 组件事件

*   `@search(queryObject)`: 当用户点击查询按钮时触发。`queryObject`是根据用户构建的条件生成的结构化数据。

#### `queryObject` 数据结构示例：

**简单模式 (不支持分组):**
```json
{
  "logic": "AND", // or "OR"
  "filters": [
    { "field": "projectName", "operator": "like", "value": "市政工程" },
    { "field": "totalInvestment", "operator": ">=", "value": 10000 }
  ]
}
```

**高级模式 (支持分组):**
```json
{
  "logic": "OR",
  "groups": [
    {
      "logic": "AND",
      "filters": [
        { "field": "projectName", "operator": "like", "value": "工程" },
        { "field": "totalInvestment", "operator": ">=", "value": 10000 }
      ]
    },
    {
      "logic": "AND",
      "filters": [
        { "field": "projectStatus", "operator": "equals", "value": "completed" }
      ]
    }
  ]
}
```

### 3.3 内部实现要点
*   **动态操作符**：组件内部需要维护一个映射关系，根据传入`fields`的`type`（string, number, date等）来决定“查询条件”下拉框中显示哪些操作符（如“包含”、“不包含”、“等于”、“大于”、“在...之间”等）。
*   **动态输入组件**：同样，根据`type`或`operator`，使用Vue的动态组件`<component :is="componentName">`来渲染正确的`Ant Design Vue`输入控件。
*   **状态管理**：在组件的`data`或`state`中维护一个数组或对象，用于实时存储用户创建的查询条件和逻辑关系，界面的渲染完全由这个状态驱动。

通过以上设计，新的`QueryBuilder`组件将极大提升高级查询功能的可用性和用户体验，同时其高度封装和可配置性也使得它能在全系统中灵活复用。